pipeline {
  agent {
    kubernetes {
      inheritFrom 'my-agent-pod'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: jnlp
    resources:
      limits:
        memory: "4Gi"
        cpu: "1"
      requests:
        memory: "4Gi"
        cpu: "1"
  - name: ubuntu-sumo
    image: ghcr.io/eclipse/eclipse-sumo-build-ubuntu:latest
    tty: true
    resources:
      limits:
        memory: "4Gi"
        cpu: "1.5"
      requests:
        memory: "4Gi"
        cpu: "1.5"
    command:
    - cat
    env:
    - name: "MAVEN_OPTS"
      value: "-Duser.home=/home/jenkins"
    volumeMounts:
    - name: settings-xml
      mountPath: /home/jenkins/.m2/settings.xml
      subPath: settings.xml
      readOnly: true
    - name: settings-security-xml
      mountPath: /home/jenkins/.m2/settings-security.xml
      subPath: settings-security.xml
      readOnly: true
    - name: m2-repo
      mountPath: /home/jenkins/.m2/repository
  volumes:
  - name: settings-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings.xml
        path: settings.xml
  - name: settings-security-xml
    secret:
      secretName: m2-secret-dir
      items:
      - key: settings-security.xml
        path: settings-security.xml
  - name: m2-repo
    emptyDir: {}
"""
    }
  }
  stages {
    stage('Building SUMO') {
      steps {
        container('ubuntu-sumo') {
          sh '''
            git config --global advice.detachedHead false

            # Cloning JuPedSim
            git clone -q --depth 1 --branch v1.3.1 https://github.com/PedestrianDynamics/jupedsim.git

            # Building JuPedSim
            cmake -Wno-dev -D CMAKE_INSTALL_PREFIX=jupedsim-install -B jupedsim-build jupedsim
            cmake --build jupedsim-build -j2 --config Release
            cmake --install jupedsim-build --config Release

            # Creating virtual env for Python for the whole process
            python3 -m venv sumo_build_env
            . sumo_build_env/bin/activate
            python -m pip install --quiet -r tools/requirements.txt -r tools/req_dev.txt

            # Building libsumo and libtraci
            export SUMO_HOME=\${WORKSPACE}
            cmake -D JUPEDSIM_CUSTOMDIR=\${WORKSPACE}/jupedsim-install -D CMAKE_BUILD_TYPE=Release -B sumo-build .
            cmake --build sumo-build -j2 --target libsumojni libtracijni
          '''
        }
      }
    }
    stage('Maven Artifact - libsumo') {
      steps {
        container('ubuntu-sumo') {
          sh '''
            cd sumo-build/src/libsumo
            mvn --batch-mode deploy
          '''
        }
      }
    }
    stage('Maven Artifact - libtraci') {
      steps {
        container('ubuntu-sumo') {
          sh '''
            cd sumo-build/src/libtraci
            mvn --batch-mode deploy
          '''
        }
      }
    }
  }
}
